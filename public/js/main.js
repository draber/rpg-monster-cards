!function(){"use strict";const t={$:(t,e=null)=>"string"==typeof t?(e||document).querySelector(t):t||null,$$:(t,e=null)=>[].slice.call((e||document).querySelectorAll(t)),waitFor:function(e,s=null){return new Promise((a=>{const r=()=>{const n=t.$(e,s);n?a(n):requestAnimationFrame(r)};r()}))},toNode:t=>{if(t.forEach&&"function"==typeof t.forEach||(t=[t]),1===(t=t.map((t=>(t=>{if(void 0===t)return document.createDocumentFragment();if(t instanceof Element||t instanceof DocumentFragment)return t;if("number"==typeof t&&(t=t.toString()),"string"==typeof t||t instanceof String){if(!/<(.*)>/.test(t))return document.createTextNode(t);let e;const s=t.includes("<svg")?"image/svg+xml":"text/html",a=(new DOMParser).parseFromString(t,s);return a.body?(e=document.createDocumentFragment(),Array.from(a.body.childNodes).forEach((t=>{e.append(t)})),e):a.documentElement}console.error("Expected Element|DocumentFragment|String|HTMLCode|SVGCode, got",t)})(t)))).length)return t[0];{const e=document.createDocumentFragment();return t.forEach((t=>{e.append(t)})),e}},empty:t=>{for(;t.lastChild;)t.lastChild.remove();return t.textContent="",t}},e=function({tag:e,content:s,attributes:a={},style:r={},data:n={},aria:i={},events:o={},classNames:l=[],isSvg:c=!1}={}){if(!c&&/[A-Z]/.test(e)&&(e=e.replace(/[\W_]+/g," ").trim().split(/ |\B(?=[A-Z])/).map((t=>t.toLowerCase())).join("-"),!customElements.get(e)))throw Error(`${e} is not a defined as a Custom Element`);const d=c?document.createElementNS("http://www.w3.org/2000/svg",e):document.createElement(e);if(new Map([["class","className"],["for","htmlFor"],["tabindex","tabIndex"],["nomodule","noModule"],["contenteditable","contentEditable"],["colspan","colSpan"],["accesskey","accessKey"]]).forEach(((t,e)=>{void 0===a[t]&&a[e]&&(a[t]=a[e]),delete a[e]})),a.style){const t={};a.style.split(";").forEach((e=>{const s=e.split(":").map((t=>t.trim()));t[s[0]]=s[1]})),r={...t,...r},delete a.style}for(let[t,e]of Object.entries(a))c?d.setAttributeNS(null,t,e.toString()):!1!==e&&(d[t]=e);for(let[t,e]of Object.entries(i))t="role"===t?t:"aria-"+t,d.setAttribute(t.toLowerCase(),e);for(let[t,e]of Object.entries(n))e=e.toString(),d.dataset[t]=e;for(const[t,e]of Object.entries(o))d.addEventListener(t,e,!1);return Object.assign(d.style,r),l.length&&d.classList.add(...l),void 0!==s&&d.append(t.toNode(s)),d};var s=new Proxy(t,{get:(t,s)=>function(){const a=Array.from(arguments);return Object.prototype.hasOwnProperty.call(t,s)&&t[s]instanceof Function?(t[s].bind(t),t[s].apply(null,a)):e({tag:s,...a.shift()})}});const a=(t,e=null,s="asc")=>t.sort(((t,a)=>(t=e?e.split(".").reduce(((t,e)=>t[e]),t):t,a=e?e.split(".").reduce(((t,e)=>t[e]),a):a,isNaN(t)||isNaN(a)?t>a?"asc"===s?1:-1:t<a?"asc"===s?-1:1:0:Number("asc"===s?t-a:a-t))));var r={group:(t,e="asc")=>{let s=a(Object.keys(t));return"desc"===e&&(s=s.reverse()),s.reduce(((e,s)=>(e[s]=t[s],e)),{})},sort:a};const n=t=>{const e={M:1e3,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1};let s="";for(let a of Object.keys(e)){const r=Math.floor(t/e[a]);t-=r*e[a],s+=a.repeat(r)}return s},i={equal:(t,e)=>t===e,notEqual:(t,e)=>t!==e,greater:(t,e)=>t>e,greaterEqual:(t,e)=>t>=e,lesser:(t,e)=>t<e,lesserEqual:(t,e)=>t<=e,instanceof:(t,e)=>t instanceof e,typeof:(t,e)=>typeof t===e,match:(t,e)=>e.test(t)},o={"===":i.equal,"!==":i.notEqual,">":i.greater,">=":i.greaterEqual,"<":i.lesser,"<=":i.lesserEqual},l=t=>{if(t instanceof Function)return t;if(i[t])return i[t];if(o[t])return o[t];throw`Unknown function ${t}`},c=t=>structuredClone instanceof Function?structuredClone(t):JSON.parse(JSON.stringify(t)),d=(t,e)=>{const s=t.toString().split(".");let a=Object.create(e);for(let t of s){if(void 0===a[t])return;a=a[t]}return a};class u{get length(){return this.keys().length}flush(){this.obj={},this.save()}save(){return this.lsKey?localStorage.setItem(this.lsKey,JSON.stringify(this.object())):null}set(t,e){const s=t.toString().split("."),a=s.pop();let r=this.obj;for(let t of s){if(r[t]||(r[t]={}),Object.getPrototypeOf(r)!==Object.prototype)throw`${t} is not of the type Object`;r=r[t]}return r[a]=e,this.save(),this}unset(t){const e=t.toString().split("."),s=e.pop();let a=this.obj;for(let t of e){if(a[t]||(a[t]={}),Object.getPrototypeOf(a)!==Object.prototype)throw`${t} is not of the type Object`;a=a[t]}return delete a[s],this.save(),this}get(t){return d(t,this.obj)}getClone(t){return c(this.get(t))}has(t){return void 0!==this.get(t)}where(t,e,s=null){return[t,e,s]}object(...t){if(!(t=t.filter((t=>Array.isArray(t)))).length)return this.obj;const e={};for(let[s,a]of Object.entries(this.obj))t.forEach((t=>{const r=d(`${s}.${t[0]}`,this.obj),n=t[2];l(t[1])(r,n)&&(e[s]=a)}));return e}entries(...t){return Object.entries(this.object.apply(this,t))}values(...t){return Object.values(this.object.apply(this,t))}keys(...t){return Object.keys(this.object.apply(this,t))}remove(...t){t.forEach((t=>{delete this.obj[t]})),this.save()}toJson(t=!1){return JSON.stringify(this.obj,null,t?"\t":null)}constructor({data:t={},lsKey:e=!1}={}){this.obj=t,this.lsKey=e}}class p extends u{keys(...t){return super.keys.apply(this,t).map((t=>parseInt(t)))}nextIncrement(){let t=this.length?this.keys().map((t=>parseInt(t))):[this.minIncrement-1];return Math.max(...t)+1}constructor({data:t={},minIncrement:e=1,lsKey:s}={}){super({data:t,lsKey:s}),this.minIncrement=e}}var h=t=>{const e=t.cid||t;if(isNaN(e))throw`${e} is not a valid character identifier`;return parseInt(e,10)},g=t=>{const e=t.tid||t;if(isNaN(e))throw`${e} is not a valid tab identifier`;return parseInt(e,10)};class b extends p{getBlank(){const t=this.nextIncrement();return{tid:t,title:n(t)}}remove(...t){super.remove(...t.map((t=>g(t))))}constructor({data:t={},minIncrement:e=1,lsKey:s}={}){super({data:t,lsKey:s,minIncrement:e})}}class m extends p{getBlank(){const t={};return this.validFields.forEach((e=>{t[e]={field:{txt:""}}})),{cid:this.nextIncrement(),fields:t}}remove(...t){super.remove(...t.map((t=>h(t))))}constructor({data:t={},minIncrement:e=1,lsKey:s,validFields:a=[]}={}){super({data:t,lsKey:s,minIncrement:e}),this.validFields=a}}class f extends u{isDefault(t,e){return e===this.get(t)}set(){return console.error("Preset values are readonly"),!1}unset(){return this.set()}constructor({data:t={}}={}){super({data:t})}}let v,y,E,x,k;const $=(t,e)=>{if("name"===e)t._groupValue=t.fields.name.field.txt.charAt(0).toUpperCase(),t._groupLabel=k.get(`lib.${e}.txt`)+": "+t._groupValue;else t._groupValue=t.fields[e].field.txt,t._groupLabel=k.get(`lib.${e}.txt`)+": "+t._groupValue;return t};var C=({groupBy:t="name",sortBy:e="name",groupDir:s="asc",sortDir:a="name"}={})=>{let n={};for(let e of y.values())e=$(e,t),n[e._groupValue]=n[e._groupValue]||[],n[e._groupValue].push(e);n=r.group(n,s);for(let[t,s]of Object.entries(n))n[t]=r.sort(s,`fields.${e}.field.txt`,a);return n};const w=function(t,e){"string"==typeof t&&(t=[t]),t.forEach((t=>{this.addEventListener(t,e)}))},j=function(t,e){"string"==typeof t&&(t=[t]),t.forEach((t=>{this.dispatchEvent(e?new CustomEvent(t,{detail:e}):new Event(t))}))};class O extends HTMLElement{get groupBy(){return this.getAttribute("groupby")}set groupBy(t){this.setAttribute("groupby",t)}get sortBy(){return this.getAttribute("sortby")}set sortBy(t){this.setAttribute("sortby",t)}get groupDir(){return this.getAttribute("groupdir")}set groupDir(t){this.setAttribute("groupdir",t)}get sortDir(){return this.getAttribute("sortdir")}set sortDir(t){this.setAttribute("sortdir",t)}populate(){const t=new DocumentFragment,e=[];let a=[];Object.values(C(this)).forEach(((r,n)=>{let i=s.ul(),o=s.details({classNames:0===n?a:[],attributes:{open:0===n},content:[s.summary({content:r[0]._groupLabel,attributes:{title:r[0]._groupLabel}}),i],events:{toggle:t=>{t.target.open&&e.forEach((e=>{if(e.isSameNode(t.target))return!0;e.open=!1}))}}});t.append(o),e.push(o),r.forEach((t=>{i.append(s.li({content:t.fields.name.field.txt,attributes:{title:t.fields.name.field.txt},data:{cid:t.cid}}))}))})),s.empty(this).append(t)}connectedCallback(){this.on("pointerdown",(t=>{if(0!==t.button)return!0;const e=t.target.closest("li");if(!e)return!1;this.app.trigger("characterSelection",(()=>{const t=y.getClone(e.dataset.cid);return t._groupLabel&&delete t._groupLabel,t._groupValue&&delete t._groupValue,t})())})),this.sortBy=this.sortBy||"name",this.groupBy=this.groupBy||"name",this.sortDir=this.sortDir||"asc",this.groupDir=this.groupDir||"asc",this.populate()}constructor(t){return(t=super(t)).on=w,t.trigger=j,t.app.on("characterOrderChange",(e=>{["sortBy","groupBy","sortDir","groupDir"].forEach((s=>{e.detail[s]&&(t[s]=e.detail[s])})),t.populate()})),t}}var L={register:t=>{O.prototype.app=t,customElements.get("character-library")||customElements.define("character-library",O)}};class A extends HTMLElement{get groupBy(){return this.getAttribute("groupby")}set groupBy(t){this.setAttribute("groupby",t)}connectedCallback(){this.on("pointerdown",(t=>{if(0!==t.button)return!0;const e=t.target.closest("li");if(!e)return!1;this.app.trigger("characterOrderChange",{groupBy:e.dataset.groupBy})})),this.groupBy=this.groupBy||"name";const t=s.svg({isSvg:!0,content:s.use({isSvg:!0,attributes:{href:"media/icons.svg#icon-sort"}})}),e=s.div({classNames:["sort-box"]}),a=s.h3({content:"Order library by:"}),r=s.ul();e.append(a,r);for(let[t,e]of Object.entries(k.get("lib"))){if(!e.vis)continue;let a=t===this.groupBy?["active"]:[];r.append(s.li({classNames:a,content:e.txt,data:{groupBy:t}}))}this.append(t,e)}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var S={register:t=>{A.prototype.app=t,customElements.get("library-organizer")||customElements.define("library-organizer",A)}};const D=(t,e,s)=>{(s=s||document.body).dataset[t]=e},N=(t,e)=>{const s=(e=e||document.body).dataset[t];switch(!0){case void 0===s||"undefined"===s:return;case["null","true","false"].includes(s):return JSON.parse(s);case!isNaN(s):return parseFloat(s,10);default:return s}};var T=(t,e)=>{delete(e=e||document.body).dataset[t]},I=N,M=D,V=(t,e)=>{D(t,!N(t,e),e)};let R;var P=(t,e)=>{R||(R=s.div({data:{undoDialogs:!0}}),document.body.append(R)),M("softDeleted",!0,t);const a=document.createElement("undo-dialog");return a.element=t,e&&(a.label=e),R.append(a),new Promise((e=>{a.on("restore",(s=>{T("softDeleted",t),e({action:"restore",element:s.detail.element})})),a.on("remove",(t=>{e({action:"remove",element:t.detail.element})}))}))},B=()=>{R&&(R=s.empty(R))};let F,H,U,K;const z=t=>{K=t||K||s.$("tab-handle",H),s.$$("tab-handle",H).forEach((t=>{t.classList.remove("active"),t.panel.classList.remove("active"),v.unset(`${g(t)}.active`),t.removeAttribute("style")}));const e=g(K);K.classList.add("active"),K.panel.classList.add("active"),v.set(`${e}.active`,!0),F.trigger("styleUpdate",{css:v.get(`${e}.css`)||{}});const a=H.getBoundingClientRect(),r=K.getBoundingClientRect(),n=H.lastChild.getBoundingClientRect(),i=a.width-(n.width+parseInt(getComputedStyle(H.lastChild).marginLeft))-r.width;if(H.classList.remove("overflown"),H.scrollWidth>H.clientWidth){H.classList.add("overflown");const t=q(K),e=i/t.length;t.forEach((t=>{t.style.maxWidth=e+"px"}))}return K},_=t=>"active"===t?K:t instanceof customElements.get("tab-handle")?t:s.$(`tab-handle[tid="${g(t)}"]`,H),q=t=>{let e=Array.from(s.$$("tab-handle",H));return t?"populated"===t?e.filter((t=>!s.$("card-base",t.panel))):"soft-deleted"===t?e.filter((t=>!t.dataset.softDeleted)):(t.forEach?t=Array.from(t):t instanceof customElements.get("tab-handle")&&(t=[t]),e.filter((e=>!t.includes(e)))):e},J=({tabEntry:t,previousTab:e,activate:a=!1}={})=>{t=t||v.getBlank();const r=document.createElement("tab-handle");r.panel=document.createElement("tab-panel"),r.container=H;for(let[e,s]of Object.entries(t))r[e]=s,r.panel[e]=s;return r.panel.removeAttribute("title"),U.append(r.panel),e?e.after(r):s.$(".adder",H).before(r),v.set(g(t),t),a&&z(r),r},W=t=>{B();let e=q(t),s=!!e.find((t=>t.classList.contains("active"))),a=q(e);e.forEach((t=>{X(t,"remove")})),a.length?s&&z(q()[0]):J({activate:!0})},X=(t,e)=>{switch(t=_(t),e){case"soft":P(t,"Tab "+t.title).then((e=>{X(t,e.action)})),v.set(`${g(t)}.softDeleted`,!0),v.values(["softDeleted","!==",!0]).length||J({activate:!0}),t.isSameNode(K)&&z(q("soft-deleted")[0]);break;case"restore":v.unset(`${g(t)}.softDeleted`);break;case"remove":F.trigger("tabDelete",Array.from(s.$$("card-base",t.panel)).map((t=>h(t)))),v.remove(t),t.remove();break;case"empty":W("populated");break;case"others":W(t),z(t);break;case"all":W()}},Z=(t,e,s)=>{const a=g(t);let r=k.get(`css.${e}`).replace(/"+/g,"'"),n=s.replace(/"+/g,"'");r===n?(v.unset(`${a}.css.${e}`),t.style.removeProperty(e)):(v.set(`${a}.css.${e}`,n),t.style.setProperty(e,n))};var Y={init:t=>{F=t,H=s.$("tab-navi",F),U=s.$("tab-content",F),F.on("singleStyleChange",(t=>{const e=(t.detail.tab||K).panel;Z(e,t.detail.name,t.detail.value)})),F.on("bulkStyleChange",(t=>{const e=t.detail.tab||K,s=e.panel,a=g(s),r={...k.get("css"),...v.get(`${a}.css`)};for(let[t,e]of Object.entries(r))Z(s,t,e);e.isSameNode(K)&&F.trigger("styleUpdate",{css:v.get(`${a}.css`)||{}})})),(()=>{const t=v.values(),e=t.filter((t=>!!t.active)),s=e.length?g(e[0]):v.keys()[0];let a;for(let e of t)if(a=J({tabEntry:e}),e.css)for(let[t,s]of Object.entries(e.css))Z(a.panel,t,s);z(_(s))})()},add:J,handleRemoval:X,setActiveTab:z,getTab:_,getTabs:q};class G extends HTMLElement{connectedCallback(){const t=s.span({content:"🞤",classNames:["adder","btn","tab"],events:{pointerup:t=>{if(0!==t.button)return!0;Y.add({activate:!0})}}});this.addEventListener("dblclick",(t=>{t.target.isSameNode(this)&&Y.add({activate:!0})})),this.append(t)}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var Q={register:t=>{G.prototype.app=t,customElements.get("tab-navi")||customElements.define("tab-navi",G)}};let tt=!0;function et(t){t.preventDefault(),this.contextMenu.show(t)}function st(t){const e=document.querySelector('[data-type="context-menu"]:not([hidden])');e&&e.hide()}var at=(t,e)=>(tt&&(document.addEventListener("pointerup",st),tt=!1),e.setAttribute("aria-role","menu"),e.dataset.type="context-menu",t.contextMenu=e,e.owner=t,e.show=t=>{e.removeAttribute("hidden"),e.isConnected||document.body.append(e),Object.assign(e.style,((t,e)=>{e.isConnected||console.warn("The context menu needs to be attached to the DOM to calculate its position"),e.offsetWidth===e.offsetHeight===0&&console.warn("The context menu needs to be displayed to calculate its position");const s=e.offsetWidth,a=e.offsetHeight,r=window.innerWidth,n=window.innerHeight,i={x:t.pageX,y:t.pageY};return{left:(i.x+s<=r?i.x:i.x-s)+"px",top:(i.y+a<=n?i.y:i.y-a)+"px"}})(t,e))},e.hide=()=>{e.hidden=!0},t.addEventListener("contextmenu",et),e),rt=t=>{t.contextMenu.remove()};const nt=[{base:"A",letters:"AⒶＡÀÁÂẦẤẪẨÃĀĂẰẮẴẲȦǠÄǞẢÅǺǍȀȂẠẬẶḀĄȺⱯ"},{base:"AA",letters:"Ꜳ"},{base:"AE",letters:"ÆǼǢ"},{base:"AO",letters:"Ꜵ"},{base:"AU",letters:"Ꜷ"},{base:"AV",letters:"ꜸꜺ"},{base:"AY",letters:"Ꜽ"},{base:"B",letters:"BⒷＢḂḄḆɃƂƁ"},{base:"C",letters:"CⒸＣĆĈĊČÇḈƇȻꜾ"},{base:"D",letters:"DⒹＤḊĎḌḐḒḎĐƋƊƉꝹÐ"},{base:"DZ",letters:"ǱǄ"},{base:"Dz",letters:"ǲǅ"},{base:"E",letters:"EⒺＥÈÉÊỀẾỄỂẼĒḔḖĔĖËẺĚȄȆẸỆȨḜĘḘḚƐƎ"},{base:"F",letters:"FⒻＦḞƑꝻ"},{base:"G",letters:"GⒼＧǴĜḠĞĠǦĢǤƓꞠꝽꝾ"},{base:"H",letters:"HⒽＨĤḢḦȞḤḨḪĦⱧⱵꞍ"},{base:"I",letters:"IⒾＩÌÍÎĨĪĬİÏḮỈǏȈȊỊĮḬƗ"},{base:"J",letters:"JⒿＪĴɈ"},{base:"K",letters:"KⓀＫḰǨḲĶḴƘⱩꝀꝂꝄꞢ"},{base:"L",letters:"LⓁＬĿĹĽḶḸĻḼḺŁȽⱢⱠꝈꝆꞀ"},{base:"LJ",letters:"Ǉ"},{base:"Lj",letters:"ǈ"},{base:"M",letters:"MⓂＭḾṀṂⱮƜ"},{base:"N",letters:"NⓃＮǸŃÑṄŇṆŅṊṈȠƝꞐꞤ"},{base:"NJ",letters:"Ǌ"},{base:"Nj",letters:"ǋ"},{base:"O",letters:"OⓄＯÒÓÔỒỐỖỔÕṌȬṎŌṐṒŎȮȰÖȪỎŐǑȌȎƠỜỚỠỞỢỌỘǪǬØǾƆƟꝊꝌ"},{base:"OI",letters:"Ƣ"},{base:"OO",letters:"Ꝏ"},{base:"OU",letters:"Ȣ"},{base:"OE",letters:"Œ"},{base:"oe",letters:"œ"},{base:"P",letters:"PⓅＰṔṖƤⱣꝐꝒꝔ"},{base:"Q",letters:"QⓆＱꝖꝘɊ"},{base:"R",letters:"RⓇＲŔṘŘȐȒṚṜŖṞɌⱤꝚꞦꞂ"},{base:"S",letters:"SⓈＳẞŚṤŜṠŠṦṢṨȘŞⱾꞨꞄ"},{base:"T",letters:"TⓉＴṪŤṬȚŢṰṮŦƬƮȾꞆ"},{base:"TZ",letters:"Ꜩ"},{base:"U",letters:"UⓊＵÙÚÛŨṸŪṺŬÜǛǗǕǙỦŮŰǓȔȖƯỪỨỮỬỰỤṲŲṶṴɄ"},{base:"V",letters:"VⓋＶṼṾƲꝞɅ"},{base:"VY",letters:"Ꝡ"},{base:"W",letters:"WⓌＷẀẂŴẆẄẈⱲ"},{base:"X",letters:"XⓍＸẊẌ"},{base:"Y",letters:"YⓎＹỲÝŶỸȲẎŸỶỴƳɎỾ"},{base:"Z",letters:"ZⓏＺŹẐŻŽẒẔƵȤⱿⱫꝢ"},{base:"a",letters:"aⓐａẚàáâầấẫẩãāăằắẵẳȧǡäǟảåǻǎȁȃạậặḁąⱥɐ"},{base:"aa",letters:"ꜳ"},{base:"ae",letters:"æǽǣ"},{base:"ao",letters:"ꜵ"},{base:"au",letters:"ꜷ"},{base:"av",letters:"ꜹꜻ"},{base:"ay",letters:"ꜽ"},{base:"b",letters:"bⓑｂḃḅḇƀƃɓ"},{base:"c",letters:"cⓒｃćĉċčçḉƈȼꜿↄ"},{base:"d",letters:"dⓓｄḋďḍḑḓḏđƌɖɗꝺ"},{base:"dz",letters:"ǳǆ"},{base:"e",letters:"eⓔｅèéêềếễểẽēḕḗĕėëẻěȅȇẹệȩḝęḙḛɇɛǝ"},{base:"f",letters:"fⓕｆḟƒꝼ"},{base:"g",letters:"gⓖｇǵĝḡğġǧģǥɠꞡᵹꝿ"},{base:"h",letters:"hⓗｈĥḣḧȟḥḩḫẖħⱨⱶɥ"},{base:"hv",letters:"ƕ"},{base:"i",letters:"iⓘｉìíîĩīĭïḯỉǐȉȋịįḭɨı"},{base:"j",letters:"jⓙｊĵǰɉ"},{base:"k",letters:"kⓚｋḱǩḳķḵƙⱪꝁꝃꝅꞣ"},{base:"l",letters:"lⓛｌŀĺľḷḹļḽḻſłƚɫⱡꝉꞁꝇ"},{base:"lj",letters:"ǉ"},{base:"m",letters:"mⓜｍḿṁṃɱɯ"},{base:"n",letters:"nⓝｎǹńñṅňṇņṋṉƞɲŉꞑꞥ"},{base:"nj",letters:"ǌ"},{base:"o",letters:"oⓞｏòóôồốỗổõṍȭṏōṑṓŏȯȱöȫỏőǒȍȏơờớỡởợọộǫǭøǿɔꝋꝍɵ"},{base:"oi",letters:"ƣ"},{base:"ou",letters:"ȣ"},{base:"oo",letters:"ꝏ"},{base:"p",letters:"pⓟｐṕṗƥᵽꝑꝓꝕ"},{base:"q",letters:"qⓠｑɋꝗꝙ"},{base:"r",letters:"rⓡｒŕṙřȑȓṛṝŗṟɍɽꝛꞧꞃ"},{base:"s",letters:"sⓢｓßśṥŝṡšṧṣṩșşȿꞩꞅẛ"},{base:"t",letters:"tⓣｔṫẗťṭțţṱṯŧƭʈⱦꞇ"},{base:"tz",letters:"ꜩ"},{base:"u",letters:"uⓤｕùúûũṹūṻŭüǜǘǖǚủůűǔȕȗưừứữửựụṳųṷṵʉ"},{base:"v",letters:"vⓥｖṽṿʋꝟʌ"},{base:"vy",letters:"ꝡ"},{base:"w",letters:"wⓦｗẁẃŵẇẅẘẉⱳ"},{base:"x",letters:"xⓧｘẋẍ"},{base:"y",letters:"yⓨｙỳýŷỹȳẏÿỷẙỵƴɏỿ"},{base:"z",letters:"zⓩｚźẑżžẓẕƶȥɀⱬꝣ"}];let it={};for(var ot=0;ot<nt.length;ot++)for(var lt=nt[ot].letters,ct=0;ct<lt.length;ct++)it[lt[ct]]=nt[ot].base;const dt=t=>(new DOMParser).parseFromString(t,"text/html").body.textContent.trim();let ut;var pt=(t,e)=>{ut||(ut=s.div({data:{undoDialogs:!0}}),document.body.append(ut)),M("softDeleted",!0,t);const a=document.createElement("undo-dialog");return a.element=t,e&&(a.label=e),ut.append(a),new Promise((e=>{a.on("restore",(s=>{T("softDeleted",t),e({action:"restore",element:s.detail.element})})),a.on("remove",(t=>{e({action:"remove",element:t.detail.element})}))}))};let ht;const gt=t=>{let e,s,a;if(t.tid){if(e=h(t),a=Y.getTab(t.tid),!a)return void bt(t,"remove");s=g(a)}else e=E.nextIncrement(),a=Y.getTab("active"),s=g(a);t={...t,tid:s,cid:e},E.set(e,t);const r=document.createElement("card-base");r.setAttribute("cid",e),r.setAttribute("tid",s),a.panel.append(r)},bt=(t,e)=>{const s=h(t);switch(e){case"soft":pt(t,E.get(`${s}.props.name`)).then((e=>{bt(t,e.action)})),E.set(`${s}.softDeleted`,!0);break;case"restore":E.unset(`${s}.softDeleted`);break;case"remove":E.remove(t),t instanceof HTMLElement&&t.remove()}};var mt={init:t=>{ht=t,ht.on("tabDelete",(t=>{t.detail.forEach((t=>{bt(t,"remove")}))})),ht.on("characterSelection",(t=>{gt(t.detail)})),(()=>{for(let t of E.values())gt(t)})()},handleRemoval:bt,add:gt,getCard:t=>s.$(`[cid="${h(t)}"]`)};const ft=(t,e)=>{vt(t.app),t.classList.add(e);const s=E.get(h(t)),a={...c(s),mode:e};a.originalCid=h(s),a.cid=x.nextIncrement(),x.set(a.cid,a),M("cardStorage",!0)},vt=t=>{const e=s.$("card-base.cut, card-base.copy",t);e&&e.classList.remove("cut","copy")};var yt={copy:t=>{ft(t,"copy")},cut:t=>{ft(t,"cut")},paste:t=>{x.values().forEach((e=>{e.tid=g(t),"cut"===e.mode&&mt.handleRemoval(mt.getCard(e.originalCid),"remove"),delete e.originalCid,e.cid=E.nextIncrement(),mt.add(e)})),vt(t.app),x.flush(),T("cardStorage")},clear:vt};class Et extends HTMLElement{makeEditable(){let t=window.getSelection();t.removeAllRanges();let e=document.createRange();this.label.contentEditable=!0,e.selectNodeContents(this.label),t.addRange(e),this.label.focus()}get title(){return this.getAttribute("title")}set title(t){this.setAttribute("title",t)}get tid(){return this.getAttribute("tid")}set tid(t){this.setAttribute("tid",t)}disconnectedCallback(){this.panel.remove(),rt(this)}connectedCallback(){const t=Y.getTab(this);at(this,document.createElement("tab-menu")),this.closer=s.span({content:"✖",classNames:["closer"]}),this.label=s.span({content:this.title,classNames:["label"],events:{blur:t=>{this.label.contentEditable=!1,this.label.textContent=dt(this.label.textContent).substring(0,30),this.title=this.label.textContent.trim(),v.set(`${g(this)}.title`,this.title),t.detail.tab},paste:e=>{if(e.preventDefault(),!0===this.label.contentEditable)return this.label.textContent=dt(e.clipboardData.getData("text")).substring(0,30),!0;x.length&&yt.paste(t)},keyup:t=>"Enter"===t.key?(t.preventDefault(),this.label.blur(),!1):"Escape"===t.key?(t.preventDefault(),this.label.textContent=this.title,this.label.blur(),!1):void 0}}),this.on("pointerup",(t=>0!==t.button||(t.target.isSameNode(this.closer)?(t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation(),Y.handleRemoval(this,"soft"),!1):(Y.setActiveTab(this),!1)))),this.on("dblclick",(()=>{this.makeEditable()})),this.append(this.label,this.closer)}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var xt={register:t=>{Et.prototype.app=t,customElements.get("tab-handle")||customElements.define("tab-handle",Et)}};class kt extends HTMLElement{constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var $t={register:t=>{kt.prototype.app=t,customElements.get("tab-content")||customElements.define("tab-content",kt)}};class Ct extends HTMLElement{get tid(){return this.getAttribute("tid")}set tid(t){this.setAttribute("tid",t)}disconnectedCallback(){rt(this)}connectedCallback(){at(this,document.createElement("tab-menu")),this.on("paste",(t=>{yt.paste(this)}))}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var wt={register:t=>{Ct.prototype.app=t,customElements.get("tab-panel")||customElements.define("tab-panel",Ct)}};const jt=t=>(delete t.active,t),Ot=({cidData:t,tidData:e}={})=>{if(t){let e=h(t),s=E.get(e),a=g(s);return{tabs:[v.get(a)].map(jt),cards:[s]}}return e?{cards:E.values(["tid","===",g(e)]),tabs:v.values(["tid","===",g(e)]).map(jt)}:{cards:E.values(),tabs:v.values().map(jt)}};var Lt=()=>`ghastly-creatures-${(new Date).toISOString().substring(0,19).replace(/[T\:]/g,"-")}.json`,At=(t,{cidData:e,tidData:s}={})=>{const a=[JSON.stringify(Ot({cidData:e,tidData:s}))];return URL.createObjectURL(new File(a,t,{type:"application/json"}))};let St,Dt;function Nt(t){t.preventDefault(),t.stopPropagation()}function Tt(t){It(t.dataTransfer.files)}function It(t){M("importState","working"),t=Array.from(t).filter((t=>!!t));const e=[];for(let s of t)e.push(new Promise(((t,e)=>{let a=new FileReader;a.onload=()=>t(a.result),a.onerror=e,a.readAsText(s)})));Promise.all(e).then((t=>{Dt.trigger("uploadComplete",{data:t,tid:St.tid})})).catch((t=>{console.error(t)}))}function Mt(t){t.target.classList.add("active")}function Vt(t){t.target.classList.remove("active")}var Rt={init:(t,e)=>{Dt=t;let a=I("importState");a?"pristine"===a&&T("importState"):M("importState","pristine"),St=(t=>{let e=s.$("file-upload");return e||(e=document.createElement("file-upload"),t.after(e)),e})(Dt),delete St.tid,e&&(St.tid=e),(()=>{const t=["dragenter","dragover"],e=["dragleave","drop"];t.concat(e).forEach((t=>{St.addEventListener(t,Nt,!1),document.body.addEventListener(t,Nt,!1)})),t.forEach((t=>{St.addEventListener(t,Mt,!1)})),e.forEach((t=>{St.addEventListener(t,Vt,!1)})),St.addEventListener("drop",Tt,!1)})()},handleUploads:function(t){It([...t])}};class Pt extends HTMLElement{connectedCallback(){const t=Y.getTab(this.owner),e=g(t),a=s.ul({content:[s.li({content:"Copy card style",events:{pointerup:t=>{if(0!==t.button)return!0;M("styleStorage",e)}}}),s.li({classNames:["storage-dependent"],data:{storage:"style"},content:"Paste card style",events:{pointerup:s=>{if(0!==s.button)return!0;v.set(`${e}.css`,v.get(`${I("styleStorage")}.css`)),T("styleStorage"),this.app.trigger("bulkStyleChange",{tab:t})}}}),s.li({content:"Reset card style",events:{pointerup:s=>{if(0!==s.button)return!0;v.set(`${e}.css`,{}),this.app.trigger("bulkStyleChange",{tab:t})}}}),s.li({classNames:["context-separator","storage-dependent"],content:"Paste card",data:{storage:"card"},events:{pointerup:e=>{if(0!==e.button)return!0;yt.paste(t)}}}),s.li({content:s.a({content:"Export cards from this tab",events:{pointerup:e=>{if(0!==e.button)return!0;const s=Lt();e.target.download=s,e.target.href=At(s,{tidData:t}),setTimeout((()=>{e.target.download="",URL.revokeObjectURL(e.target.href)}),200)}}})}),s.li({content:s.a({content:"Import cards into this tab",events:{pointerup:t=>{if(0!==t.button)return!0;Rt.init(this.app,e)}}})}),s.li({classNames:["context-separator"],content:"Rename tab",events:{pointerup:e=>{if(0!==e.button)return!0;t.makeEditable()}}}),s.li({content:"Close tab",events:{pointerup:e=>{if(0!==e.button)return!0;Y.handleRemoval(t,"soft")}}}),s.li({classNames:["context-separator"],content:"Close empty tabs",events:{pointerup:e=>{if(0!==e.button)return!0;Y.handleRemoval(t,"empty")}}}),s.li({classNames:["context-danger"],content:"Close others permanently",events:{pointerup:e=>{if(0!==e.button)return!0;Y.handleRemoval(t,"others")}}}),s.li({classNames:["context-danger"],content:"Close all permanently",events:{pointerup:e=>{if(0!==e.button)return!0;Y.handleRemoval(t,"all")}}})]});this.append(a)}constructor(t){return t=super(t)}}var Bt={register:t=>{Pt.prototype.app=t,customElements.get("tab-menu")||customElements.define("tab-menu",Pt)}};class Ft extends HTMLElement{connectedCallback(){this.app.on("singleStyleChange",(t=>{this.style.setProperty(t.detail.name,t.detail.value)})),this.app.on("styleUpdate",(t=>{const e={...k.get("css"),...t.detail.css};for(let[t,s]of Object.entries(e))this.style.setProperty(t,s)}))}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var Ht={register:t=>{Ft.prototype.app=t,customElements.get("style-editor")||customElements.define("style-editor",Ft)}};class Ut extends HTMLElement{normalize(t){return t.replace(/"+/g,"'")}get name(){return this.getAttribute("name")}set name(t){this.setAttribute("name",t)}connectedCallback(){if(!this.name)throw Error('Missing attribute "name" on <font-selector> element');const t=this.normalize(k.get(`css.${this.name}`));let e=k.get("fonts");const a=s.select({style:{fontFamily:`var(${this.name})`},content:e.map((e=>{let a=this.normalize(e.family);return s.option({attributes:{value:a,selected:a===t},style:{fontFamily:a},content:e.label})})),data:{prop:this.name},events:{change:t=>{this.app.trigger("singleStyleChange",{name:this.name,value:this.normalize(t.target.value)})}}});this.append(a),this.app.on("styleUpdate",(s=>{const r=this.normalize(s.detail.css[this.name]||t);a.selectedIndex=e.findIndex((t=>this.normalize(t.family)===r)),s.detail.css[this.name]&&a.dispatchEvent(new Event("change"))}))}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var Kt={register:t=>{Ut.prototype.app=t,customElements.get("font-selector")||customElements.define("font-selector",Ut)}};class zt extends HTMLElement{get name(){return this.getAttribute("name")}set name(t){this.setAttribute("name",t)}connectedCallback(){if(!this.name)throw Error('Missing attribute "name" on <font-size> element');const t=k.get(`css.${this.name}`);let e=t.match(/^(?<num>[\d\.]+)(?<unit>[a-z]+)$/),a=parseFloat(e.groups.num,10),r=e.groups.unit,n=.7*a,i=1.3*a,o=(i-n)/100;const l=s.input({attributes:{type:"range",step:o,min:n,max:i,value:a},data:{prop:this.name},events:{input:t=>{this.app.trigger("singleStyleChange",{name:this.name,value:t.target.value+r})}}});this.append(l),this.app.on("styleUpdate",(s=>{const n=s.detail.css[this.name]||t;e=n.match(/^(?<num>[\d\.]+)(?<unit>[a-z]+)$/),a=parseFloat(e.groups.num,10),r=e.groups.unit,l.value=a,s.detail.css[this.name]&&l.dispatchEvent(new Event("input"))}))}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var _t={register:t=>{zt.prototype.app=t,customElements.get("font-size")||customElements.define("font-size",zt)}};class qt extends HTMLElement{get value(){return this.getAttribute("value")}set value(t){this.setAttribute("value",t)}get name(){return this.getAttribute("name")}set name(t){this.setAttribute("name",t)}get type(){return this.getAttribute("type")}set type(t){this.setAttribute("type",t)}getUrl(t,e){return`url(${"html"===e?"media/patterns":"../media/patterns"}/${this.type}/${t.split("/").pop()})`}getValue(){for(let t of s.$$("input",this))if(t.checked)return t.value}connectedCallback(){if(!this.name)throw Error('Missing attribute "name" on <pattern-selector> element');if(!this.type)throw Error('Missing attribute "type" on <pattern-selector> element');const t=k.get(`css.${this.name}`),e=[],a=k.get(this.type).map((a=>{let r=s.input({attributes:{type:"radio",name:`${this.type}-pattern`,value:this.getUrl(a.name,"css"),id:`${this.type}-${a.id}`,checked:this.getUrl(a.name,"css")===t}});return e.push(r),s.li({style:{backgroundImage:this.getUrl(a.name,"html")},attributes:{title:a.label},content:[r,s.label({attributes:{for:`${this.type}-${a.id}`}})]})})),r=s.ul({content:a,events:{change:t=>{this.app.trigger("singleStyleChange",{name:this.name,value:this.getValue()})}}});this.append(r),this.app.on("styleUpdate",(s=>{const a=s.detail.css[this.name]||t;e.find((t=>t.value===a)).checked=!0,s.detail.css[this.name]&&r.dispatchEvent(new Event("change"))}))}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var Jt={register:t=>{qt.prototype.app=t,customElements.get("pattern-selector")||customElements.define("pattern-selector",qt)}};const Wt=t=>Math.round(1e4*t.value)/1e4+t.unit;var Xt=t=>{const e={};for(let[s,a]of Object.entries(t))e[s]=a.value;return e},Zt=(t,e)=>{const s=[];return Object.values(t).forEach((t=>{s.push(Wt(t))})),4===s.length?`${e}(${s[0]} ${s[1]} ${s[2]} / ${s[3]})`:`${e}(${s[0]} ${s[1]} ${s[2]})`},Yt=Wt;const Gt=(t,e)=>{switch(t){case"b":return"hwb"===e?"%":"";case"l":case"s":case"w":return"%"}return""},Qt=(t,e,s)=>{const a=((t,e)=>"lab"===e&&["a","b"].includes(t)?-160:0)(e,s),r=((t,e)=>{switch(t){case"c":return 230;case"h":return 360;case"r":case"g":return 255;case"b":return"lab"===e?160:"rgb"===e?255:100;case"a":return 160;case"α":return 1}return 100})(e,s),n=(r-a)/100;t=((t,e,s)=>{let a=parseFloat(t),r=t.match(/[a-z%]+/),n=r?r[0]:"";switch(e){case"s":case"l":case"w":case"c":case"a":return a;case"r":case"g":return"%"===n?255*a/100:a;case"α":return"%"===n?a/100:a;case"h":switch(n){case"grad":return 360*a/400;case"turn":return 360*a;case"rad":return a*(180/Math.PI);default:return a}case"b":switch(s){case"rgb":return"%"===n?255*a/100:a;case"hwb":case"lab":return a}}return 100})(t,e,s);return{unit:Gt(e,s),step:n,min:a,max:r,value:t}},te=t=>{let e,s={tracks:{}},a=/^(?<type>hex|#|rgba|hsla|rgb|hsl|hwb|lab|lch)?\(?(?<value>[^\)]+)/g.exec(t.trim());if(!a||!a.groups)return console.error(`Invalid value "${t}"`),!1;t=a.groups.value,["hex","#"].includes(a.groups.type)?(s.type="rgb",e=(t=>{const e=(t.length<6?t.split(""):t.match(/\w{1,2}/g)).map((t=>1===t.length?t.padEnd(2,t):t)).map((t=>parseInt(t,16).toString()));return 4===e.length&&(e[3]=(e[3]/255).toString()),e})(t)):(s.type=a.groups.type.substring(0,3),e=t.replace(/[,\/]+/g," ").split(/\s+/).map((t=>t.trim())));const r=s.type.split("").concat(["α"]);return e.forEach(((t,e)=>{s.tracks[r[e]]=Qt(t,r[e],s.type)})),s.original=Zt(s.tracks,s.type),s};var ee=(t,e)=>{for(let[s,a]of Object.entries(e)){let r=a.value,n=["to right"],i=(a.max-a.min)/10;for(let r=a.min;r<a.max;r+=i)e[s].value=r,n.push(Zt(e,t));e[s].value=r,a.element.style.background=`linear-gradient(${n.join(",")})`}};class se extends HTMLElement{get value(){return this.getAttribute("value")}set value(t){this.setAttribute("value",t)}get name(){return this.getAttribute("name")}set name(t){this.setAttribute("name",t)}get disabled(){return this.getAttribute("disabled")}set disabled(t){t?this.setAttribute("disabled",""):this.removeAttribute("disabled")}getInitialColor(){const t=this.name.replace("-color","-"),e=[];return["h","s","l"].forEach((s=>{e.push(k.get(`css.${t}${s}`))})),`hsl(${e.join(" ")})`}fireEvent(t){return this.dispatchEvent(new CustomEvent(t,{bubbles:!0,cancelable:!0,detail:{value:this.value,channels:Xt(this.tracks)}}))}connectedCallback(){if(!this.name)throw Error('Missing attribute "name" on <color-selector> element');this.value||(this.value=this.getInitialColor());const t=te(this.value);this.tracks=t.tracks,this.value=t.original;const e=s.input({attributes:{type:"hidden",value:this.value,name:this.name}});this.append(e);const a=[];for(let[r,n]of Object.entries(this.tracks)){const i=s.label(),o=s.span({content:this.dataset[r+"Label"]||("α"!==r?r.toUpperCase():r)}),l=s.span();i.append(o,l);const c=s.input({data:{channel:r,unit:n.unit},attributes:{type:"range",min:n.min,max:n.max,step:n.step,name:`${this.name.replace("color",r)}`,value:n.value}});this.tracks[r].element=c,c.addEventListener("input",(s=>{s.stopPropagation(),this.tracks[s.target.dataset.channel].value=s.target.value,this.value=Zt(this.tracks,t.type),e.value=this.value,ee(t.type,this.tracks);const a=Yt(this.tracks[s.target.dataset.channel]);this.app.trigger("singleStyleChange",{name:s.target.name,value:a})})),c.addEventListener("change",(t=>{t.stopPropagation(),this.fireEvent(t.type)})),l.append(c),a.push(c),this.append(i)}ee(t.type,this.tracks),this.app.on("styleUpdate",(t=>{for(let e of a){const s=t.detail.css[e.name]||this.tracks[e.dataset.channel].value;e.value=parseFloat(s,10),e.dispatchEvent(new Event("input"))}}))}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var ae={register:t=>{se.prototype.app=t,customElements.get("color-selector")||customElements.define("color-selector",se)}};function re(t,e,s,a,r="short"){let n=h(t);return"txt"===a&&"label"===s?`${n}.fields.${e}.${s}.${a}.${r}`:`${n}.fields.${e}.${s}.${a}`}function ne(t,e,s,a="short"){return"txt"===s&&"label"===e?`cards.${t}.${e}.${s}.${a}`:`cards.${t}.${e}.${s}`}function ie(t,e,s,a,r="short"){let n=h(t);return"label"===s&&"txt"===a?E.get(re(n,e,s,a,r)):E.get(re(n,e,s,a))}function oe(t,e,s,a="short"){return"label"===e&&"txt"===s?k.get(ne(t,e,s,a)):k.get(ne(t,e,s))}var le={isVisible:function(t,e,s){let a=h(t);if(!E.has(`${a}.fields.${e}`)&&!k.has(`cards.${e}`))return!1;if("field"===s&&!ie(a,e,s,"txt"))return!1;const r=ie(a,e,s,"vis");return void 0!==r?r:oe(e,s,"vis")},getValue:function(t,e,s,a,r="short"){const n=ie(t,e,s,a,r),i=oe(e,s,a,r);return void 0!==n?n:i},getCardPath:re,getPresetPath:ne,getPresetValue:oe,getCardValue:ie};class ce extends HTMLElement{get cid(){return this.getAttribute("cid")}set cid(t){this.setAttribute("cid",t)}get tid(){return this.getAttribute("tid")}set tid(t){this.setAttribute("tid",t)}get tabindex(){return this.getAttribute("tabindex")}set tabindex(t){this.setAttribute("tabindex",t)}updateRow(t,e,s,a="short"){let r=le.getPresetPath(t.detail.key,e,s,a),n=le.getCardPath(this.cid,t.detail.key,e,s,a);const i=k.get(r),o=E.get(n);t.detail.value!==i?E.set(n,t.detail.value):void 0!==o&&E.unset(n)}connectedCallback(){["recto","verso","form","toolbar"].forEach((t=>{this[t]=document.createElement(`card-${t}`),this[t].card=this}));const t=s.article({content:[s.div({classNames:["card-view"],content:[this.recto,this.verso]}),this.form,this.toolbar]});this.append(t),this.tabIndex=0,this.on("fieldContentChange",(t=>{this.updateRow(t,"field","txt")})),this.on("labelContentChange",(t=>{this.updateRow(t,"label","txt","short")})),this.on("fieldVisibilityChange",(t=>{this.updateRow(t,"field","vis")})),this.on("labelVisibilityChange",(t=>{this.updateRow(t,"label","vis")})),this.on("orderChange",(t=>{let e={};t.detail.order.forEach((t=>{e[t]=E.get(`${this.cid}.fields.${t}`)})),E.set(`${this.cid}.fields`,e),this.trigger("afterOrderChange")})),this.on("characterCut",(function(t){yt.cut(this)})),this.on("characterCopy",(function(t){yt.copy(this)})),this.on("characterRemove",(function(t){mt.handleRemoval(this,"soft")})),this.on("characterEdit",(function(t){M("cardState","edit"),this.classList.add("editable")})),this.on("characterDone",(function(t){T("cardState"),this.classList.remove("editable")})),this.on("keyup",(t=>{if(this.classList.contains("editable"))return!0;t.ctrlKey&&["x","c"].includes(t.key)&&yt["x"===t.key?"cut":"copy"](this),"Escape"===t.key&&yt.clear(this),"Delete"===t.key&&mt.handleRemoval(this,"soft")}))}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var de={register:t=>{ce.prototype.app=t,customElements.get("card-base")||customElements.define("card-base",ce)}};let ue=null;const pe={dragstart:function(t){t.stopPropagation(),ue=this,t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/html",this.outerHTML),ue.classList.add("dragElem")},dragenter:function(t){},dragover:function(t){return t.preventDefault(),this.classList.add("dragover"),t.dataTransfer.dropEffect="move",!1},dragleave:function(t){this.classList.remove("dragover")},drop:function(t){return t.stopPropagation(),ue.isSameNode(this)||this.after(ue),this.classList.remove("dragover"),ue.classList.remove("dragElem"),!1},dragend:function(t){this.classList.remove("dragover")}};function he(t,e){const s=e?"addEventListener":"removeEventListener";t.draggable=e;for(let[e,a]of Object.entries(pe))t[s](e,a,!1)}var ge={toggle:he,enable:function(t){return he(t,!0)},disable:function(t){return he(t,!1)}};class be extends HTMLElement{icon(t){let e,a=[`media/icons.svg#icon-show-${t}`,`media/icons.svg#icon-hide-${t}`];switch(t){case"field":e="Display this item on the card";break;case"label":e="Display the item label";break;case"drag":e="Drag item to different position",a=["media/icons.svg#icon-drag-grip"]}return a=a.map((t=>s.use({isSvg:!0,attributes:{href:t}}))),s.svg({isSvg:!0,content:[s.title({isSvg:!0,content:e})].concat(a)})}buildRow(t){const e=this.buildCells(t),a=s.tr({attributes:{draggable:!0},data:{key:t,field:le.isVisible(this.card,t,"field"),label:le.isVisible(this.card,t,"label")},content:e});return ge.enable(a),a.addEventListener("dragend",(t=>{this.card.trigger("orderChange",{order:(t=>Array.from(s.$$("[data-key]",this.tbody.closest("table"))).map((t=>t.dataset.key)))()})})),a}buildCells(t){function e(t,e){const s=t.target.closest("[draggable]");if(!s)return!0;ge[e](s)}const a={focus:t=>e(t,"disable"),blur:t=>e(t,"enable"),keyup:t=>t.target.textContent=dt(t.target.textContent),paste:t=>t.target.textContent=dt(t.target.textContent)},r={label:s.th({data:{type:"label"},attributes:{contentEditable:!0},content:le.getValue(this.card,t,"label","txt"),events:a}),element:s.td({data:{type:"field"},attributes:{contentEditable:!0},content:le.getValue(this.card,t,"field","txt"),events:a}),labelIcon:s.td({data:{type:"label"},classNames:["icon","toggle"],content:this.icon("label")}),cardIcon:s.td({data:{type:"field"},classNames:["icon","toggle"],content:this.icon("field")}),dragIcon:s.td({classNames:["icon","handle"],content:this.icon("drag")})};return Object.values(r)}populateTbody(){for(let t of Object.keys(E.get(`${this.card.cid}.fields`)).filter((t=>!["img","name"].includes(t))))this.tbody.append(this.buildRow(t))}connectedCallback(){this.card=this.closest("card-base"),this.tbody=s.tbody();const t=s.table({content:[s.caption({attributes:{contentEditable:!0},data:{key:"name",type:"field"},content:le.getValue(this.card,"name","field","txt")}),s.thead({content:[s.tr({data:{key:"img"},content:[s.th({content:le.getValue(this.card,"img","label","txt","long")}),s.td({attributes:{colSpan:4,contentEditable:!0},data:{type:"field"},content:le.getValue(this.card,"img","field","txt")})]})]}),this.tbody],events:{input:t=>{if(!t.target.contentEditable)return!0;this.card.trigger(`${t.target.dataset.type}ContentChange`,{key:t.target.closest("[data-key]").dataset.key,value:t.target.textContent})},pointerup:t=>{const e=t.target.closest(".toggle");if(0!==t.button||!e)return!0;const s=e.closest("[data-key]"),a=s.dataset.key,r=e.dataset.type;V(r,s);const n=I(r,s);this.card.trigger(`${r}VisibilityChange`,{key:a,value:n})}}});this.populateTbody(),this.append(t)}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var me={register:t=>{be.prototype.app=t,customElements.get("card-form")||customElements.define("card-form",be)}};class fe extends HTMLElement{connectedCallback(){const t=s.figure({classNames:["frame"]}),e={img:s.img({attributes:{src:le.getValue(this.card,"img","field","txt")}}),name:s.figcaption({classNames:["badge"],content:le.getValue(this.card,"name","field","txt")})};for(let s of Object.values(e))t.append(s);this.card.on("fieldContentChange",(t=>{const s="img"===t.detail.key?"src":"textContent";e[t.detail.key]&&(e[t.detail.key][s]=t.detail.value)})),this.append(t)}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var ve={register:t=>{fe.prototype.app=t,customElements.get("card-recto")||customElements.define("card-recto",fe)}};class ye extends HTMLElement{connectedCallback(){const t=s.button({attributes:{type:"button",name:"done"},content:["Done"],events:{pointerup:t=>{this.card.trigger("characterDone")}}}),e=s.a({classNames:["button"],content:["Export"],events:{pointerup:t=>{if(0!==t.button)return!0;const e=Lt();t.target.download=e,t.target.href=At(e,{cidData:this.card}),setTimeout((()=>{t.target.download="",URL.revokeObjectURL(t.target.href)}),200)}}}),a=s.button({attributes:{type:"button"},content:["Cut"],events:{pointerup:t=>{if(0!==t.button)return!0;this.card.trigger("characterCut")}}}),r=s.button({attributes:{type:"button"},content:["Copy"],events:{pointerup:t=>{if(0!==t.button)return!0;this.card.trigger("characterCopy")}}}),n=s.button({attributes:{type:"button"},content:["Delete"],events:{pointerup:t=>{if(0!==t.button)return!0;this.card.trigger("characterRemove")}}}),i=s.button({attributes:{type:"button"},content:["Edit"],events:{pointerup:t=>{if(0!==t.button)return!0;this.card.trigger("characterEdit")}}});this.append(t,n,e,a,r,i)}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var Ee={register:t=>{ye.prototype.app=t,customElements.get("card-toolbar")||customElements.define("card-toolbar",ye)}};class xe extends HTMLElement{populateTbody(t){t=s.empty(t);for(let e of Object.keys(E.get(`${this.card.cid}.fields`)).filter((t=>!["img","name"].includes(t))))t.append(this.buildRow(e))}buildRow(t){const e={label:s.th({content:le.getValue(this.card,t,"label","txt","short")}),field:s.td({content:le.getValue(this.card,t,"field","txt")})};this.rowObj[t]=e;return s.tr({data:{key:t,field:le.isVisible(this.card,t,"field"),label:le.isVisible(this.card,t,"label")},content:Object.values(e)})}connectedCallback(){const t={name:s.caption({classNames:["badge"],content:le.getValue(this.card,"name","field","txt")}),cr:s.div({classNames:["badge","cr"],content:le.getValue(this.card,"cr","field","txt")})},e=s.tbody(),a=s.table({classNames:["frame"],content:[t.name,e]});this.rowObj={},this.populateTbody(e),this.append(a,t.cr),this.card.on("fieldContentChange",(e=>{Object.keys(t).includes(e.detail.key)&&(t[e.detail.key].textContent=e.detail.value),Object.keys(this.rowObj).includes(e.detail.key)&&(this.rowObj[e.detail.key].field.textContent=e.detail.value)})),this.card.on("labelContentChange",(t=>{Object.keys(this.rowObj).includes(t.detail.key)&&(this.rowObj[t.detail.key].label.textContent=t.detail.value)})),this.card.on("fieldVisibilityChange",(t=>{Object.keys(this.rowObj).includes(t.detail.key)&&(this.rowObj[t.detail.key].field.parentElement.dataset.field=t.detail.value)})),this.card.on("labelVisibilityChange",(t=>{Object.keys(this.rowObj).includes(t.detail.key)&&(this.rowObj[t.detail.key].label.parentElement.dataset.label=t.detail.value)})),this.card.on("afterOrderChange",(t=>{this.populateTbody(e)}))}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var ke={register:t=>{xe.prototype.app=t,customElements.get("card-verso")||customElements.define("card-verso",xe)}};class $e extends HTMLElement{connectedCallback(){const t=s.span({content:"×",classNames:["closer","btn"],events:{pointerup:t=>{if(0!==t.button)return!0;this.trigger("remove",{element:this.element}),this.remove()}}}),e=s.button({attributes:{type:"text"},events:{pointerdown:t=>{if(0!==t.button)return!0;this.trigger("restore",{element:this.element}),this.remove()}},content:"Undo"}),a=s.h2({content:`${this.label||"An element"} has been deleted`}),r=s.aside({content:[t,a,e]});this.append(r),setTimeout((()=>{this.trigger("remove",{element:this.element}),this.remove()}),1e4)}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var Ce={register:()=>{customElements.get("undo-dialog")||customElements.define("undo-dialog",$e)}};class we extends HTMLElement{connectedCallback(){const t=s.div({classNames:["import-export-menu"],content:[s.a({attributes:{download:""},content:"Export cards",events:{pointerup:t=>{if(0!==t.button)return!0;const e=Lt();t.target.download=e,t.target.href=At(e),setTimeout((()=>{t.target.download="",URL.revokeObjectURL(t.target.href)}),200)}}}),s.a({attributes:{download:!0},content:"Import cards",events:{pointerup:t=>{if(0!==t.button)return!0;Rt.init(this.app)}}})]});document.addEventListener("keyup",(t=>{"Escape"===t.key&&"pristine"===I("importState")&&T("importState")})),this.append(t)}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var je={register:t=>{we.prototype.app=t,customElements.get("import-export")||customElements.define("import-export",we)}};let Oe,Le;const Ae=t=>{t.forEach((t=>{const e=Oe.getBlank();e.originalTid=g(t.tid),Oe.set(e.cid,e);for(let s of Object.keys(e.fields))t.fields[s]&&(t.fields[s].field&&(t.fields[s].field.txt&&Oe.set(`${e.cid}.fields.${s}.field.txt`,dt(t.fields[s].field.txt)),void 0!==t.fields[s].field.vis&&Oe.set(`${e.cid}.fields.${s}.field.vis`,!!t.fields[s].field.vis)),t.fields[s].label&&(void 0!==t.fields[s].label.txt&&(void 0!==t.fields[s].label.txt.short&&Oe.set(`${e.cid}.fields.${s}.label.txt.short`,dt(t.fields[s].label.txt.short)),void 0!==t.fields[s].label.txt.long&&Oe.set(`${e.cid}.fields.${s}.label.txt.long`,dt(t.fields[s].label.txt.long))),void 0!==t.fields[s].label.vis&&Oe.set(`${e.cid}.fields.${s}.label.vis`,!!t.fields[s].label.vis)))}))},Se=(t,e)=>{const s=e?void 0:["originalTid","===",g(t.originalTid)];for(let[a,r]of Oe.entries(s))delete r.originalTid,r.tid=e||g(t),Oe.set(a,r);e||Le.unset(`${t.tid}.originalTid`)},De=t=>{const e=Object.keys(t);return e.includes("tabs")&&e.includes("cards")&&Array.isArray(t.tabs)&&Array.isArray(t.cards)&&t.tabs.length&&t.cards.length};var Ne=(t,e)=>{t=t.map((t=>JSON.parse(t)));for(let e=0;e<t.length;e++)De(t[e])||(t.splice(e,1),console.error("Invalid import data discarded"));if(!t.length)return console.error("No valid import data found, aborting"),T("importState"),!1;Oe=new m({data:{},minIncrement:E.nextIncrement(),validFields:Object.keys(k.get("cards"))}),Le=new b({data:{},minIncrement:v.nextIncrement()});let s=[];return t.forEach((t=>{e?(t.cards.map((t=>(t.tid=e,t))),Ae(t.cards),Se(v.get(e),e),s.push(Y.getTab(e))):(Ae(t.cards),(t=>{const e=Object.keys(k.get("css"));t.forEach((t=>{const s=Le.getBlank();if(s.originalTid=t.tid,/^[CDILMVX]+$/.test(t.title)||(s.title=dt(t.title)),Le.set(s.tid,s),t.css)for(let a in e)t.css[a]&&Le.set(`${s.tid}.css.${a}`,dt(t.css[a]))}))})(t.tabs),Le.values().forEach((t=>{Se(t),t=Y.add(t),s.push(t)}))),Oe.values().forEach((t=>{mt.add(t)})),T("importState")})),s};class Te extends HTMLElement{connectedCallback(){const t=s.div({classNames:["spinner"],content:s.svg({isSvg:!0,content:s.use({isSvg:!0,attributes:{href:"media/icons.svg#icon-axe"}})})}),e=s.label({content:[s.span({classNames:["button"],content:"select"}),s.input({attributes:{type:"file",multiple:!0,accept:"application/json"},events:{change:t=>{Rt.handleUploads(t.target.files),t.target.value=""}}})]}),a=s.form({content:[s.p({content:["Drop or ",e," your Ghastly Creatures files"]})]});this.app.on("uploadComplete",(t=>{let e=Ne(t.detail.data,t.detail.tid);e.length&&Y.setActiveTab(e[0])})),this.append(a,t)}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}var Ie={register:t=>{Te.prototype.app=t,customElements.get("file-upload")||customElements.define("file-upload",Te)}};const Me={...{storageKeys:{cards:"gc-cards",tabs:"gc-tabs"}},...{css:{entryPoint:"src/css/main.css",public:"public/css/main.css"},presets:{target:"public/js/presets.json",url:"js/presets.json"},js:{entryPoint:"src/js/app/main.js",public:"public/js/main.js"},characters:{src:"src/data/monsters.json",target:"public/js/characters.json",url:"js/characters.json"}}};class Ve extends HTMLElement{connectedCallback(){const t=new u({data:Me}),e={tabs:JSON.parse(localStorage.getItem(Me.storageKeys.tabs)||"{}"),system:{},presets:{},stored:JSON.parse(localStorage.getItem(Me.storageKeys.cards)||"{}"),settings:t};Promise.all([fetch(Me.characters.url),fetch(Me.presets.url)]).then((t=>Promise.all(t.map((t=>t.json()))))).then((t=>{e.characters=t[0],e.presets={...t[1],storageKeys:Me.storageKeys},(t=>{if(k=new f({data:t.presets}),v=new b({data:t.tabs,lsKey:k.get("storageKeys.tabs")}),0===v.length){const t=v.getBlank();v.set(t.tid,t)}const e=Object.keys(t.presets.cards);y=new m({validFields:e}),t.characters.forEach((t=>{const s=y.getBlank();e.forEach((e=>{t[e]&&(s.fields[e].field.txt=t[e])})),y.set(s.cid,s)})),E=new m({data:t.stored,lsKey:k.get("storageKeys.cards"),minIncrement:3001,validFields:e}),x=new m({minIncrement:6001})})(e),[$t,xt,Q,wt,Bt,Ht,je,Ie,L,S,Kt,_t,Jt,ae,de,me,ve,Ee,ke,Ce].forEach((t=>{t.register(this)})),Y.init(this),mt.init(this)}))}constructor(t){return(t=super(t)).on=w,t.trigger=j,t}}customElements.define("app-container",Ve,{extends:"main"})}();
